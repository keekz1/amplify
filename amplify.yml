version: 1
backend:
  phases:
    build:
      commands:
        # Increase memory limit to avoid crashes
        - export NODE_OPTIONS="--max-old-space-size=8192"
        
        # Generate Prisma client early
        - npx prisma generate --no-engine
        
        # Install dependencies with minimal resource usage
        - npm ci --no-audit --prefer-offline --ignore-scripts
        
        # Apply schema changes (Use db push if not using migrations)
        - npx prisma migrate deploy || npx prisma db push

frontend:
  phases:
    preBuild:
      commands:
        - npm ci --no-audit --prefer-offline --ignore-scripts
    build:
      commands:
        - export NODE_OPTIONS="--max-old-space-size=8192"
        
        # Clean up unnecessary cache files to free up memory
        - rm -rf .next .swc node_modules/.cache
        
        # Build Next.js frontend with limited threads to prevent memory overflow
        - node --max-old-space-size=8192 ./node_modules/next/dist/bin/next build

cache:
  paths:
    - .next/cache/**/*
    - node_modules/.prisma/client/**/*
